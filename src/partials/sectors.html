<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <link rel="icon" type="image/svg+xml" href="/Logo.svg" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Рівненська обласна дитяча лікарня</title>
        <link rel="stylesheet" href="../css/styles.css" />
</head>
<body>
  <load src="partials/header.html" icon-path="img/sprite.svg#logo" />
  <section class="coll-centr">
    <div class="container">
      <ul class="breadcrumb">
        <li><a href="/">Головна</a></li>
        <li>Відділення та центри</li>
      </ul>
      <h1>Відділення та центри</h1>

      <div id="departments-list"></div>
    </div>
  </section>

  <load src="partials/footer.html" />

  <script>
    const basePath = window.location.origin + "/rodl-temp";
    /*async function loadDepartments() {
      const response = await fetch("https://rodl-proxy.vercel.app/api/departments");
      const departments = await response.json();
      console.log(departments);
      renderDepartments(departments);
    }*/

    /* Use LocalStorage */

    async function loadDepartments() {
        const cached = localStorage.getItem("departments");
        const cachedTime = localStorage.getItem("departments_time");

        const now = Date.now();
        const DAY = 24 * 60 * 60 * 1000;

        if (cached && cachedTime && (now - cachedTime) < DAY) {
          console.log("Loaded from cache");
          return renderDepartments(JSON.parse(cached));
        }

        const response = await fetch("https://rodl-proxy.vercel.app/api/departments");
        const data = await response.json();

        // зберегти на добу
        localStorage.setItem("departments", JSON.stringify(data));
        localStorage.setItem("departments_time", now);

        renderDepartments(data);
      }

    function renderDepartments(list) {
      const container = document.getElementById("departments-list");

      list.forEach((dep, idx) => {
        const item = document.createElement("div");
        item.className = "department";

        const photos = Object.keys(dep)
          .filter(key => key.startsWith("Фото") && dep[key])
          .map(key => dep[key]);

        item.innerHTML = `
          <div class="dep-header">
            <h2>${dep["Назва"]}</h2>
            <p class="short">${dep["Короткий опис"]}</p>
            <button class="toggle sector-button" data-id="${idx}">Докладніше ↓</button>
          </div>

          <div class="dep-full" id="dep-${idx}" style="display:none;">
            <p class="more-text"><b>Телефон:</b> ${dep["Телефон"]}</p>
            <p class="more-text"><b>Керівник:</b> ${dep["Керівник (посада/ПІБ/спеціальність)"]}</p>
            <p class="more-text"><b>Старша медсестра:</b> ${dep["Старша медсестра"]}</p>
            <p class="full-text">${dep["Повний опис"]}</p>

            <div class="carousel">
              ${photos.map(p => `<img src="${basePath}/img/departments/${p}" alt="${dep["Назва"]}">`).join("")}
            </div>
          </div>
        `;

        container.appendChild(item);
      });

      initToggle();
    }

    function initToggle() {
      document.querySelectorAll(".toggle").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const block = document.getElementById("dep-" + id);

          if (block.style.display === "none") {
            block.style.display = "block";
            btn.innerText = "Згорнути ↑";
          } else {
            block.style.display = "none";
            btn.innerText = "Докладніше ↓";
          }
        });
      });
    }

    loadDepartments();
  </script>
</body>

</html>